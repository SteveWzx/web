<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>无标题文档</title>
<style>
*{ margin:0; padding:0;}
li{ list-style:none;}
#div1,#div2{ float:left; width:400px; height:400px; border:1px #000000 solid; margin:10px; position:relative; overflow:hidden;}
#div2 ul{ position:absolute; left:0; width:2000px;}
#div2 ul .box{ width:400px; height:400px; float:left; overflow:hidden;}
#div2 #childUl{ width:400px;}
#childUl li{ width:400px; border-bottom:1px #666666 dashed;}
#map{ width:100%; height:380px;}
</style>
<script src="http://api.map.baidu.com/api?v=1.3"></script>
<script>


function startMove(obj,json,endFn){
	
	clearInterval(obj.timer);
	
	obj.timer = setInterval(function(){
		
		var bBtn = true;
		
		for(var attr in json){
			
			var iCur = 0;
		
			if(attr == 'opacity'){
				if(Math.round(parseFloat(getStyle(obj,attr))*100)==0){
				iCur = Math.round(parseFloat(getStyle(obj,attr))*100);
				
				}
				else{
					iCur = Math.round(parseFloat(getStyle(obj,attr))*100) || 100;
				}	
			}
			else{
				iCur = parseInt(getStyle(obj,attr)) || 0;
			}
			
			var iSpeed = (json[attr] - iCur)/8;
		iSpeed = iSpeed >0 ? Math.ceil(iSpeed) : Math.floor(iSpeed);
			if(iCur!=json[attr]){
				bBtn = false;
			}
			
			if(attr == 'opacity'){
				obj.style.filter = 'alpha(opacity=' +(iCur + iSpeed)+ ')';
				obj.style.opacity = (iCur + iSpeed)/100;
				
			}
			else{
				obj.style[attr] = iCur + iSpeed + 'px';
			}
			
			
		}
		
		if(bBtn){
			clearInterval(obj.timer);
			
			if(endFn){
				endFn.call(obj);
			}
		}
		
	},30);

}
	
	
function getStyle(obj,attr){
	if(obj.currentStyle){
		return obj.currentStyle[attr];
	}
	else{
		return getComputedStyle(obj,false)[attr];
	}
}



window.onload = function(){
	var oDiv1 = document.getElementById('div1');
	var oT = document.getElementById('t1');
	var aInput1 = oDiv1.getElementsByTagName('input');
	
	
	var oChildUl = document.getElementById('childUl');
	var aChildLi = oChildUl.getElementsByTagName('li');
	
	var iNow = window.localStorage.getItem('num') || 0;
	var index = 0;
	
	var oUl = document.getElementById('ul1');
	var aBox = document.getElementsByClassName('box');
	
	
	var aBox2_input = aBox[1].getElementsByTagName('input');
	var aBox2_div = aBox[1].getElementsByTagName('div');
	
	var aBox3_input = aBox[2].getElementsByTagName('input');
	
	if(navigator.onLine){
		aInput1[2].disabled = false;
	}
	else{
		aInput1[2].disabled = true;
	}
	
	for(var i=0;i<iNow;i++){
		var oLi = document.createElement('li');
		oLi.innerHTML = window.localStorage.getItem('title'+i);
		oChildUl.appendChild(oLi);
	}
	toChangeLi();
	
	
	aInput1[1].onclick = function(){  //本地保存
	
		window.localStorage.setItem('title'+iNow,aInput1[0].value);
		window.localStorage.setItem('text'+iNow,oT.value);
		
		iNow++;
		
		window.localStorage.setItem('num',iNow);
	
		createLi();
	
	};
	
	aInput1[2].onclick = function(){  //同步服务器
	};
	
	aInput1[3].onclick = function(){  //删除所有数据
		window.localStorage.clear();
	};
	
	aInput1[4].onclick = function(){  //记录地图位置
	
		navigator.geolocation.getCurrentPosition(function(position){
		
			var y = position.coords.longitude;
			var x = position.coords.latitude;
			
			window.localStorage.setItem('y'+iNow,y);
			window.localStorage.setItem('x'+iNow,x);
		
		});
	
	};
	
	function createLi(){
		var oLi = document.createElement('li');
		oLi.innerHTML = aInput1[0].value;
		oChildUl.appendChild(oLi);
		
		toChangeLi();
		
	}
	
	function toChangeLi(){
		for(var i=0;i<aChildLi.length;i++){
			aChildLi[i].index = i;
			aChildLi[i].onclick = function(){
				
				startMove(oUl,{left : - aBox[0].offsetWidth });
				
				aBox2_div[0].innerHTML = window.localStorage.getItem('title'+this.index);
				aBox2_div[1].innerHTML = window.localStorage.getItem('text'+this.index);
				
				//alert(!window.localStorage.getItem('y'+this.index));
				if(  !window.localStorage.getItem('y'+this.index) ){
					
					aBox2_input[1].disabled = true;
				}
				else{
					aBox2_input[1].disabled = false;
				}
				
				index = this.index;
				
			};
		}
	}
	
	aBox2_input[0].onclick = function(){  //后退
		
		startMove(oUl,{left : 0 });
		
	};
	
	aBox2_input[1].onclick = function(){  //前进
		
		
		if(!navigator.onLine){
			alert('只有在线才能访问地图');
			return false;
		}
		
		startMove(oUl,{left : -aBox[0].offsetWidth*2 });
		
		var y = window.localStorage.getItem('y'+index);
		var x = window.localStorage.getItem('x'+index)
		
		var map = new BMap.Map("map");
		var point = new BMap.Point(y, x);
		map.centerAndZoom(point,15); 
		
		var opts = {
		  width : 250,     // 信息窗口宽度
		  height: 100     // 信息窗口高度
		}
		
		var infoWindow = new BMap.InfoWindow(aBox2_div[0].innerHTML, opts);  // 创建信息窗口对象
map.openInfoWindow(infoWindow,point); //开启信息窗口
		 
		map.enableScrollWheelZoom();
		var marker = new BMap.Marker(point);        
		map.addOverlay(marker); 
		
	};
	
	aBox3_input[0].onclick = function(){
	
		startMove(oUl,{left : -aBox[0].offsetWidth});
	
	};
	
};



</script>
</head>

<body>
<div id="div1">
标题:<input type="text" /><br />
内容:<textarea id="t1" style="height:300px; width:300px;"></textarea><br />
<input type="button" value="保存本地" />
<input type="button" value="同步服务器" />
<input type="button" value="删除所有数据" />
<input type="checkbox" />记录地图位置
</div>
<div id="div2">
	<ul id="ul1">
		<li class="box">
			<ul id="childUl">
			</ul>
		</li>
		<li class="box">
			<input type="button" value="后退" />
			<input style="float:right" type="button" value="前进" />
			<div></div>
			<div></div>
		</li>
		<li class="box">
			<input type="button" value="后退" />
			<div id="map"></div>
		</li>
	</ul>
</div>
</body>
</html>
